
ikPolishShader 詳説

--------------------------------------------------------------------------------
■ 概要

ikPolishShaderはPBR(物理ベースレンダリング)風のシェーダーです。
素材特性をあらわすパラメータを元に、周囲の物体を映りこませることで
立体感と素材感を出すことができます。

v.0.20で大幅に設計を変えたため、従来版との互換性はありません。

古いバージョンでの説明になりますが、使用方法やパラメータの設定について説明しています。
http://ch.nicovideo.jp/ikeno/blomaga/ar745854
http://www.nicovideo.jp/watch/sm27733338
http://www.nicovideo.jp/watch/sm27742363
　※ 仕様変更のため、現在とは挙動が異なっている場合があります。


--------------------------------------------------------------------------------
■ 目次
・使用方法
・ファイルの内容
・ikPolishShader.fxsub内の設定
・材質ファイル
・mainファイル
・MMEタブ
・追加ライト
・コントローラ
・軽量化のために
・重くする
・トラブルシューティング
・既知の問題


--------------------------------------------------------------------------------
■ 使用方法

□ 少しだけ細かい設定

0. モデルを読み込む。
　※ できるだけ背景を読み込んでください。このエフェクトはモデルに
　背景を映りこませることを目的としているため、無地の背景ではエフェクトの効果が出ません。
　無地の背景にしたい場合は、ライティング用に適当なスカイドームを追加してMainで非表示にすることを一考してください。

1. MMDに ikPolishShader.x を追加する。
　しばらく時間が掛かる場合があります。
　時間が掛かりすぎる場合は、「軽量化のために」の節を読んでください。

2. MMEのエフェクト割り当て：
2-1. Mainタブで、モデルやステージなどに Main/PolishMain.fx を割り当てる。
　※ スカイドームには割り当てないでください。

2-2. EnvMapタブで、モデルに映りこんで欲しくないものを除外する。

2-3. EnvMapタブで、スカイドームに対して、Environments/TEnvMap_emissive.fxを割り当てる。
　光っているもの、ライトの影響を受けないものにTEnvMap_emissive.fxを割り当てます。
　※ HDRから変換したスカイドームを使用している場合は、TEnvMap_rgbm.fxを割り当ててください。
　※ rgbm_skydome.xを使用している場合は、自動でTEnvMap_rgbm.fxが割り当てられます。

3. アクセサリの描画順序を変更する。
　パーティクルなどの表示系のエフェクトよりは後に、
　レンズフレア、色調整、DoFなどより前のほうがいいでしょう。

4. ikPolishController.pmx を追加する。
　表情モーフでikPolishShader の動作を調整するためのコントローラです。
　無くても動作します。


□ 素材の設定

1. 材質にあったマテリアルを設定する。
　MMEのエフェクト割り当てで、ColorMapRTタブを選択し、
　キャラのモデルをサブセット展開します。
　各材質にあったマテリアルを設定します。

　モデル全体で同じ材質の場合は、サブセット展開は不要です。

　金属には、Materialフォルダ内のMaterial_Metal.fx を、
　顔にはMaterial_face.fx、体にはMaterial_skin.fx
　を割り当ててください。

　スカイドームなど、このシェーダーの影響を受けたくないものには、
　Material_Mask.fx を割り当てます。

　他のエフェクトのコントローラなど、描画に関係ないモデルは
　表示チェックを外します。


2. Material.fx をカスタマイズする。
　Material.fxをコピーペーストして、独自のMaterial.fxを作ります。
　自分の分かりやすい名前に変更したほうがよいでしょう。
　たとえば、服用であれば Material_Cloth.fx など。

　編集内容に関しては後述の「材質ファイル」を参考にしてください。

3. モデルの反射色、反射強度を修正。
　MMDのモデルでは、スペキュラが弱めに設定されていることが多いので、
　必要に応じて、PMXエディタなどで反射強度を調整する必要があります。

　※ モデルデータを書き換える場合は、オリジナルデータのバックアップを取ってから行ってください。

　ハイライトの強さは、マテリアルファイルでも指定可能です。


　金属材質の場合、モデルに設定された反射色を参照します。
　MMDのモデルでは反射色が黒(0,0,0)に設定されている場合、
　適宜設定しなおす必要があります。
　非金属の場合は、反射色が常に白(1,1,1)とみなされます。

　ハイライトの色も、マテリアルファイルで指定可能です。


5. 素材の分離
　モデルによっては、異なる素材がPMX内で同じ材質に設定されている場合があります。
　例：脚とタイツ、靴が一体化している。

　この場合は、PMXエディタなどで素材毎に材質を分離するか、
　材質テクスチャで材質を指定する必要があります。


--------------------------------------------------------------------------------
■ ファイルの内容
　(詳細を知る必要がないと思われるファイルは除外しました)

　ikPolishShader.x　　　　アクセサリ
　ikPolishShader.fx　　　 エフェクトファイル
　ikPolishShader.fxsub　　エフェクト間で共有する設定ファイル。
　ikPolishController.pmx　コントローラ。光の強さなどを制御する。無くても動作する。

　Environmentsフォルダ
　　環境マップ用エフェクトファイル

　　TEnvMap.fx　　通常のオブジェクト用
　　TEnvMap_emissive.fx
　　　陰影計算をしないオブジェクト用。スカイドーム、自己発光している物など。
　　TEnvMap_rgbm.fx
　　　HDRIテクスチャを使用したスカイドーム用。

　Mainフォルダ
　　mainタブに割り当てるエフェクトファイル

　　PolishMain.fx　　　Mainタブ用。full.fxの代わりに使用する。
　　PolishMain_glass.fx　ガラス用。半透明でもハイライトが強く出る。
　　PolishMain_clearcoat.fx　ツルツルな材質用
　　　ワックスを塗った車のようになる。

　　forward_glass.fx　ガラス用2
　　　全体的に半透明な材質に使用することで、その材質の奥の材質を有効にする。
　　　※ ikPolishは一番手前の材質情報しか保存しないため、手前に半透明な材質があると
　　　その背後の材質は無効になります。

　　　ガラス材質をColorMapRTから外して、mainでこのファイルを割り当てると、
　　　ガラスの背後を通常のPolishの光源計算で処理し、ガラスに対して擬似的な反射を追加する。

　　内容の詳細については後述の「mainファイル」を参考にしてください。

　Materialsフォルダ
　　材質設定用のエフェクトファイル群
　　カスタマイズして使用することを前提にしています。
　　※ Materialsファイルを別フォルダに移す場合、Materials/Sourcesフォルダ以下もコピーする必要があります。

　　Material.fx　　　　　非金属用(デフォルト)
　　Material_mask.fx 　　エフェクトを無効にする。スカイドームに使用する。
　　Material_metal.fx　　金属用
　　Material_skin.fx 　　肌用。
　　Material_face.fx 　　顔用。Material_skinより影の影響が弱い。
　　Material_leaf.fx 　　葉っぱ、一部の布用。裏側から光が透過する材質用。
　　Material_light.fx　　追加ライト用。

　　内容については後述の「材質ファイル」を参考にしてください。

　Sourcesフォルダ
　　エフェクトが内部で使用するファイル

　Supplementsフォルダ
　　マテリアルテスト用のpmxや、スカイドームなど。


--------------------------------------------------------------------------------
■ ikPolishShader.fxsub内の設定

　主要なもののみを列挙

　QUALITY_LEVEL
　　一括での品質レベル設定。
　　0が精度を下げて速度を上げる。2が速度を落として品質を上げる。
　　3は細かく設定を変更する場合用。

　SHADOW_QUALITY
　　シャドウマップのクオリティを調整する。
　　大きい数字ほどクオリティが高く、重くなる。

　RLRRayCount
　RLRRayCount2
　　映り込むものを調査する回数。多いほど正確で重い。
　　映り込むものが少ない場合は0にして無効にしたほうが軽くなります。

　SSAORayCount
　　奥まった部分に光が届くかどうか調査する回数。
　　多いほど正確で重い。0で無効。

　RSMCount
　　床や壁からの照り返しを計算するかどうか。その精度。
　　0で無効。16〜64で計算回数。大きい値ほど正確で重くなる。

　ENABLE_SSGI
　　ぼんやりした映り込みを行うかどうか。
　　白いシャツに周りの色が映り込むような効果が出る。

　SSAO_QUALITY
　　凹み部分を暗くする影のクオリティを調整する。
　　大きい数字ほどクオリティが高く、メモリを消費する。

　EXTRA_LIGHTS
　　追加ライトに対応する。
　　ここで0を指定すると、追加ライトが使えない代わりに多少高速化する。

　ENABLE_FOG
　　擬似的な空気遠近を有効にする。

　ENABLE_REFRACTION
　　擬似的な屈折表現を有効にする。
　　ここで0を指定すると、屈折表現が使えない代わりに多少高速化する。


--------------------------------------------------------------------------------
■ 材質ファイル

□ 基本的な設定

　MATERIAL_TYPE
　　材質の特性を指定する。

　　MT_NORMAL　: 通常 (金属を含む)
　　MT_FACE　　: 肌 (顔用)
　　MT_LEAF　　: 葉やカーテンなど、裏が透ける材質用。
　　　現在は肌もここに属している。実際の人間は鼻や耳など骨がない部分でだけ透ける。 
　　MT_MASK　　: スカイドーム用。

　TEXTURE_FILENAME_*
　　材質をテクスチャで指定する場合のテクスチャファイル名。最大で4つまで指定可能。

　METALNESS (0.0〜1.0)
　　金属度。
　　金属なら1、非金属なら0にする。宝石類では0.1〜0.2程度を指定する。
　　金属の上に塗料が塗られている場合、1より小さい値にする。
　　光沢がある材質の場合、非金属でも0.1〜0.2程度を指定することがある。

　SMOOTHNESS (0.0〜1.0)
　　表面の滑らかさ/ザラつき度合い。
　　SMOOTHNESS_TYPEによって値の意味が変わる。

　EMISSIVE (0.0〜8.0)
　　発光強度。
　　EMISSIVE_TYPEによって、発光量の算出方式が変わる。
　　※ 皮下散乱度とともに使用できない。

　SSS (0.0〜1.0)
　　皮下散乱度。(Sub-Surface Scattering)
　　肌、半透明なプラスチックなどで透ける度合いを指定する。0:不透明。1:半透明。
　　※ 発光度とともに使用できない。発光度がある材質では、皮下散乱度は無視される。

　INTENSITY (0.0〜2.0)
　　ハイライト強度
　　ハイライトの強さを設定する。0でハイライトオフ。


□ テクスチャによる各パタメータの設定：

　xxx_VALUE
　　テクスチャを使用せず、材質単位で値を一括指定する場合の数値。

　xxx_MAP_ENABLE
　　テクスチャで値を指定するかどうか。
　　0ならxxx_VALUEの値が使われ、1なら以下で指定したテクスチャの値が使われる。

　xxx_MAP_FILE
　　テクスチャファイル番号。
　　TEXTURE_FILENAME_* の 末尾の数字で参照するテクスチャファイルを指定する。

　xxx_MAP_CHANNEL
　　テクスチャのチャンネルを指定。
　　Rなら赤、G,B,Aならそれぞれ、緑、青、透明度の値を使用する。

　xxx_MAP_LOOPNUM
　　テクスチャの繰り返し回数。
　　カラーテクスチャと大きさが一致している場合は1を指定する。
　　1.0以上の値を指定することで、テクスチャが細かくなる。

　xxx_MAP_SCALE
　xxx_MAP_OFFSET
　　テクスチャ値の係数。
　　「テクスチャの値 × SCALE ＋ OFFSET」が最終的な値になる。


□ 補助設定

　AlphaThreshold
　　半透明の材質の無視するしきい値
　　これより小さい透明度の場合、無視される。


□ 法線マップ指定

　NORMALMAP_ENABLE
　　法線マップを使用する。0:未使用。1:使用する。

　NORMALMAP_SUB_ENABLE
　　サブ法線マップを使用する。0:未使用。1:使用する。
　　※ NORMALMAP_ENABLE が 0の場合、NORMALMAP_SUB_ENABLEの値に無関係に法線マップは使用できません。


　NORMALMAP_MAIN_FILENAME
　　メイン法線マップ名

　NORMALMAP_MAIN_LOOPNUM
　　メイン法線マップの繰り返し回数

　NORMALMAP_MAIN_HEIGHT
　　メイン法線マップの高さ補正。
　　正の値で高くなる。0で平坦。負の値も指定可能。

　NORMALMAP_SUB_FILENAME
　NORMALMAP_SUB_LOOPNUM
　NORMALMAP_SUB_HEIGHT
　　サブ法線マップ(微細な凹凸用)。詳細はメイン法線マップを参照。


□ 他シェーダーの設定の利用

　v.0.20から簡略化のために、他シェーダーの設定を利用できなくしました。


--------------------------------------------------------------------------------
■ mainファイル
　※ v.0.20からmainでの指定を大幅に簡略化しました。

□ PolishMain 系

　ENABLE_VELVET
　　ベルベット効果を有効にするか。
　　輪郭を明るくする。

　　VELVET_***_COLORが、正面から見た場合の色、VELVET_***_RIM_COLORが
　　視線と垂直になっている部分の色になる。

　　(元の色 * VELVET_MUL_***) + VELVET_ADD_*** で材質の色が決定され、
　　そこにライティングが行われる。


　ENABLE_CLEARCOAT
　　クリアコート表現を有効にする。
　　マテリアルで指定したスペキュラに追加して、第二のスペキュラを与えることができる。


　IGNORE_SPHERE
　　完全にスフィアマップを無視する
　SphereScale
　　スフィアマップの強さを調整する。

　ENABLE_SPECULAR_ALPHA
　　半透明モデルでもスペキュラの強度を維持する。
　　通常、半透明度に応じてハイライトは弱くしますが、ガラスなどで半透明な材質でも
　　光の反射を強くしたい場合、1を指定します。

　ToonColor_Scale
　　影の色を ToonColor の設定に従って変調する度合。

　Enable_Cutout
　　指定したアルファ値の以上か以下かで表示のオン/オフを決定する。
　　葉っぱなどのテクスチャでエッジが汚くなる場合に使用すると改善できる。


□ forward 系

　forward_glass.fxは半透明表現用のシェーダーです。

　ikPolishは1ピクセルに1つの材質情報しか保存しないため、
　半透明な材質が手前にあると、その奥にある材質が正しく描画されません。

　ガラスのように完全に半透明な材質を描画する場合、
　ColorMapRT, SSAOMapRTから除外して、Mainでforward_glassを割り当てることで、
　半透明な材質の奥にある物体が正しく描画されます。

　代わりにforward適用部分が不正確になります。
　半透明部分を優先させる場合は従来通りの設定を使ってください。


--------------------------------------------------------------------------------
■ MMEタブ

　ikPolishが使用するタブの説明

　Main
　　通常の描画を行うためのMMD標準のタブ
　　ikPolishで描画する対象にはMainフォルダ内にあるエフェクトを割り当てる。
　　ikPolishShaderで事前に計算された情報を元に色を決定する。

　LightMapRT
　　追加ライトの計算用エフェクトを指定する。
　　追加ライト以外にチェックが付いている場合は外してください。

　ColorMapRT
　　モデルの材質情報など計算に必要な情報を書き出す。
　　各材質に従って、Materialsフォルダ内のエフェクトを割り当てる。
　　エフェクトは材質毎にカスタマイズする。

　EnvMapRT
　　鏡のようなモデルに映り込む画像を作成する。

　　デフォルトで.pmx,.pmdは除外されます。
　　背景が.pmxなどの場合、手動で描画対象にする必要があります。

　　街灯、空(スカイドーム)などMMDのライトの影響を受けないと思われる材質には、
　　TEnvMap_emissive.fxを割り当ててください。


　RSMMapRT (Reflective Shadow Map)
　　MMDライトの床や壁での反射を計算するための情報を出力する。

　SSAOMapRT (Screen Space Ambient Occlusion)
　　SSAO用の深度を設定する。

　LightDepthRT
　　シャドウマップ用にライトからの距離を計算する。
　　このタブでチェックを外したモデルは影を落とさなくなる。
　　影を落とさないモデルはここから除外しておいたほうが多少高速になる。


--------------------------------------------------------------------------------
■ 追加ライト

　※ ikPolishShader.fxsub内の EXTRA_LIGHTS が0になっていると使用できません。

　Lightsフォルダ内のPointLight.pmx、SpotLight.pmx、SphereLight.pmx、PanelLight.pmx
　をmmdに入れてください。

　同じライトを複数同時に使用することができます。
　各.pmxの表情モーフで設定を行うことができます。

　Lightsフォルダ内のPL_**.fx内で各ライトのシャドウマップの設定などを変更できます。


□ 各ライトについて

　PointLight.pmx
　　ポイントライト。従来のPPointLight*.xの代わり。

　SpotLight.pmx
　　スポットライト。懐中電灯などのように特定方向だけを照らすライト。
　　割り当ててあるテクスチャを変更することで光の形状を変更できる。

　SphereLight.pmx
　　大きさのある球形ライト。
　　割り当ててあるテクスチャを変更することで光の形状を変更できる。
　　mainには、PolishMain_emissive.fx を割り当てる。

　PanelLight.pmx
　　大きさのある矩形のライト。
　　割り当ててあるテクスチャを変更することで光の形状を変更できる。
　　mainには、PolishMain_emissive.fx を割り当てる。

　TubeLight.pmx
　　細長いライト。

　※ 影を落とす場合、PointLight、SphereLight、TubeLightは全方向に影を落とす
　　必要があるため重くなります。SpotLight、PanelLightで代用できる場合は、
　　そちらを使うほうが高速になります。


--------------------------------------------------------------------------------
■ コントローラ

　※ コントローラを使用しない場合、すべての項目で0をしたのと同じ結果になります。

　直接光+/-　　ライトからの光の強弱を調整する。
　間接光+/-　　アンビエント項(空の色などの周囲からの影響)の強弱を調整する。
　SSAO+/-　　　SSAO(隅や狭まった部分を暗くする効果)の強さを調整する。
　SSAOバイアス　SSAO由来のノイズが出る場合に調整する。
　映り込み+/-　鏡面反射による映り込みの強さを調整する。
　SSS+/- 　　　半透明な物体で光が滲む効果を調整する。肌の透明感に影響する。
　GI+/-　　　　拡散反射による映り込みの強さを調整する。
　シャドウ 　　影をボカす強さを調整する。1で最大にボカす。
　フォグ距離 　空気遠近の掛かり始める距離を調整する。
　フォグ濃度 　空気遠近の濃度を調整する。


--------------------------------------------------------------------------------
■ 軽量化のために

　ikPolishShader.fxsub内のQUALITY_LEVEL を 0にしてみる。
　　作業中はQUALITY_LEVEL:0にしておき、動画出力時にQUALITY_LEVEL:1にする。

　　QUALITY_LEVELを3(カスタム)にして不要な機能をカットする。
　　カット候補：
　　　RSMCount (床からの光の反射表現)
　　　EXTRA_LIGHTS (MMD標準ライト以外の追加ライトの有効化)
　　　RLRRayCount2 (映り込み表現の高機能版)
　　　RLRRayCount (映り込み表現)
　　　ENABLE_REFRACTION (屈折表現)

　MMEのエフェクト割当で、ikPolishの使用する ColorMapRT, ENvMapRT, 
　　RSMMapRT, SSAOMapRT, LightDepthRTタブから、不要そうなものを外す。


■ 重くする
　軽量化とは逆に速度を犠牲にしてもクオリティを向上させる方法。

　ikPolishShader.fxsub内の
　　QUALITY_LEVEL を 3にして、いろいろなパラメータの数値を上げてみる。

　MMDメニューの出力サイズを倍にする。
　　出力後にAviUtlや画像編集ソフトで動画/画像サイズを小さくする。


--------------------------------------------------------------------------------
■ トラブルシューティング

　重い
　　→ readme_detail.txtの「軽量化のために」を読んで、軽い設定にしてみる。

　暗い
　・光の当たっている場所が暗い
　　 1. MMDのライト色を大きな値にする。
　　 2. ikPolishController.pmxを入れて、直接光+で明るくする。

　・光の当たっていない場所が暗い
　　 1. EnvMapタブのスカイドームにTEnvMap_emissive.fxが割り当てられているか調べる。
　　 2. ikPolishController.pmxを入れて、間接光+で明るくする。
　　 3. スカイドームを明るいものに変える。
　　 4. LightDepthRTから光を遮っているものを外して、光を当てる。


　縁の部分がズレる。細い線が変に表示される。
　　 1. MMDのアンチエイリアスを無効にする。
　　 2. 大きくレンダリングして縮小して誤魔化す。

　金属なのに映り込まない。
　　材質の反射色の問題：
　　 1. PMXエディタを開いて材質をチェックする。
　　　スペキュラカラー(鏡面反射色)が黒くないか調べる。
　　　暗い場合は、(0.5,0.5,0.5)以上の値にする。
　　 2. マテリアルファイルで、SPECULAR_COLOR_TYPE を1にしてみる。

　　材質の滑らかさの問題：
　　 1. PMXエディタを開いて材質をチェックする。
　　　反射強度が低ければ、60程度にしてみる。
　　 2. MaterialMapの SMOOTHNESS_TYPE を 1か2にして、直接値を設定してみる。
　　　または、材質マップでSmoothnessを設定する。
　　　※ 材質の反射強度が小さいほど、Smoothnessが小さいほどハイライトや映り込みが暗くなります。

　　映りこむ側の問題：
　　 1. 周囲に映り込むものがない場合、スカイドームをおいてみる。


　アップになったキャラの影が消える。
　　 1. Shadows/shadow_common.fxsub 内の CascadeZMin を
　　　 3.0などにすることで対処できます。


--------------------------------------------------------------------------------
■ 既知の問題

　半透明を正しく扱うことができません。
　→ ikPolishShader.fxsub 内の AlphaThreshold の値を変更すると改善できる場合があります。


　目が暗くなる。
　→ MMDモデルによっては白目が現実の目玉のように凸状の球体ではなく、
　　凹状の眼窩になっている場合があります。
　　ikPolishはその形状のまま陰影計算を行うために、影が落ちて暗くなります。

　　supplementsフォルダの Proxyeye を目の部分に置くことで、陰影計算をごまかすことができます。


ikeno
Twitter: @ikeno_mmd
